var Mark={statements:{},includes:{},includeFunction:null,globals:{},delimiter:">",compact:!1,_copy:function(t,n){n=n||[];for(var e in t)n[e]=t[e];return n},_size:function(t){return t instanceof Array?t.length:t||0},_iter:function(t,n){this.idx=t,this.size=n,this.length=n,this.sign="#",this.toString=function(){return this.idx+this.sign.length-1}},_pipe:function(t,n){var e,i,r,o;if(e=n.shift()){i=e.split(this.delimiter),r=i.shift().trim();try{o=Mark.pipes[r].apply(null,[t].concat(i)),t=this._pipe(o,n)}catch(s){}}return t},_eval:function(t,n,e){var i,r,o=this._pipe(t,n),s=o,u=-1;if(o instanceof Array)for(o="",i=s.length;++u<i;)r={iter:new this._iter(u,i)},o+=e?Mark.up(e,s[u],r):s[u];else o instanceof Object&&(o=Mark.up(e,s));return o},_test:function(t,n,e,i){var r=Mark.up(n,e,i).split(/\{\{\s*else\s*\}\}/);return(t===!1?r[1]:r[0])||""},_bridge:function(t,n){n="."==n?"\\.":n.replace(/\$/g,"\\$");var e,i,r="{{\\s*"+n+"([^/}]+\\w*)?}}|{{/"+n+"\\s*}}",o=new RegExp(r,"g"),s=t.match(o)||[],u=0,c=0,l=-1,p=0;for(i=0;i<s.length&&(e=i,l=t.indexOf(s[e],l+1),s[e].indexOf("{{/")>-1?c++:u++,u!==c);i++);return u=t.indexOf(s[0]),c=u+s[0].length,p=l+s[e].length,[t.substring(u,p),t.substring(c,l)]}};Mark._echo=function(t){var n,e,i,r;if(i=t.context[t.prop],void 0!==(e=this.globals[t.prop]))n=this._eval(e,t.filters,t.child);else if(include=this.includes[t.prop])include instanceof Function&&(include=include()),n=this._pipe(Mark.up(include,t.context,t.options),t.filters);else if(t.prop.indexOf("#")>-1)t.options.iter.sign=t.prop,n=this._pipe(t.options.iter,t.filters);else if("."===t.prop)n=this._pipe(t.context,t.filters);else if(t.prop.indexOf(".")>-1){for(t.prop=t.prop.split("."),i=Mark.globals[t.prop[0]],i?r=1:(r=0,i=t.context);i&&r<t.prop.length;)i=i[t.prop[r++]];n=this._eval(i,t.filters,t.child)}else t.stmt?n=this._pipe(i,t.filters):i instanceof Array?n=this._eval(i,t.filters,t.child):t.child?n=i?Mark.up(t.child,i):void 0:t.context.hasOwnProperty(t.prop)&&(n=this._pipe(i,t.filters));return n instanceof Array&&(n=this._eval(n,t.filters,t.child)),n},Mark.statements.echo=Mark._echo,Mark._else=function(t){return t.tag},Mark.statements["else"]=Mark._else,Mark._if=function(t){var n;return t.filters.length||(t.filters=["notempty"]),n=this._echo(t),n=this._test(n,t.child,t.context,t.options)},Mark.statements["if"]=Mark._if,Mark._include=function(t){var n;return(n=this.includes[t.prop])?n instanceof Function&&(n=n()):this.includeFunction instanceof Function&&(n=this.includeFunction(t.prop),this.includes[t.prop]=n),n?this._pipe(Mark.up(n,t.context,t.options),t.filters):void 0},Mark.statements.include=Mark._include,Mark.up=function(t,n,e){n=n||{},e=e||{};var i,r,o,s,u,c,l,p,a=/\{\{(.+?)\}\}/g,f=t.match(a)||[],h=[],d=0;for(e.pipes&&this._copy(e.pipes,this.pipes),e.includes&&this._copy(e.includes,this.includes),e.includeFunction&&(this.includeFunction=e.includeFunction),e.globals&&this._copy(e.globals,this.globals),e.delimiter&&(this.delimiter=e.delimiter),void 0!==e.compact&&(this.compact=e.compact);i=f[d++];)c="",u=i.indexOf("/}}")>-1,r=i.substr(2,i.length-(u?5:4)),r=r.replace(/`(.+?)`/g,function(t,e){return Mark.up("{{"+e+"}}",n)}),s=r.trim().split(" ")[0],o=Mark.statements[s],h=r.split("|"),h.shift(),r=o?r.trim().substr(s.length+1):r,r=r.split("|").shift().trim(),s=o?s:r,!u&&t.indexOf("{{/"+s)>-1&&(l=this._bridge(t,s),i=l[0],c=l[1],d+=i.match(a).length-1),p={context:n,options:e,tag:i,prop:r,stmt:o,filters:h,child:c},o=o?o:Mark.statements.echo,l=o.call(this,p),l!==i&&(t=t.replace(i,void 0===l?"???":l));return this.compact?t.replace(/>\s+</g,"><"):t},Mark.pipes={empty:function(t){return t&&0!==(t+"").trim().length?!1:t},notempty:function(t){return t&&(t+"").trim().length?t:!1},blank:function(t,n){return t||0===t?t:n},more:function(t,n){return Mark._size(t)>n?t:!1},less:function(t,n){return Mark._size(t)<n?t:!1},ormore:function(t,n){return Mark._size(t)>=n?t:!1},orless:function(t,n){return Mark._size(t)<=n?t:!1},between:function(t,n,e){return t=Mark._size(t),t>=n&&e>=t?t:!1},equals:function(t,n){return t==n?t:!1},notequals:function(t,n){return t!=n?t:!1},like:function(t,n){return new RegExp(n,"i").test(t)?t:!1},notlike:function(t,n){return Mark.pipes.like(t,n)?!1:t},upcase:function(t){return String(t).toUpperCase()},downcase:function(t){return String(t).toLowerCase()},capcase:function(t){return t.replace(/(?:^|\s)\S/g,function(t){return t.toUpperCase()})},chop:function(t,n){return t.length>n?t.substr(0,n)+"...":t},tease:function(t,n){var e=t.split(/\s+/);return e.slice(0,n).join(" ")+(e.length>n?"...":"")},trim:function(t){return t.trim()},pack:function(t){return t.trim().replace(/\s{2,}/g," ")},round:function(t){return Math.round(+t)},clean:function(t){return String(t).replace(/<\/?[^>]+>/gi,"")},size:function(t){return t.length},length:function(t){return t.length},reverse:function(t){return[].concat(t).reverse()},join:function(t,n){return t.join(n)},limit:function(t,n,e){return t.slice(+e||0,+n+(+e||0))},split:function(t,n){return t.split(n||",")},choose:function(t,n,e){return t?n:e||""},toggle:function(t,n,e,i){return e.split(",")[n.match(/\w+/g).indexOf(t+"")]||i},sort:function(t,n){var e=function(t,e){return t[n]>e[n]?1:-1};return[].concat(t).sort(n?e:void 0)},fix:function(t,n){return(+t).toFixed(n)},mod:function(t,n){return+t%+n},divisible:function(t,n){return t&&+t%n===0?t:!1},even:function(t){return t&&0===(1&+t)?t:!1},odd:function(t){return t&&1===(1&+t)?t:!1},number:function(t){return parseFloat(t.replace(/[^\-\d\.]/g,""))},url:function(t){return encodeURI(t)},bool:function(t){return!!t},falsy:function(t){return!t},first:function(t){return 0===t.idx},last:function(t){return t.idx===t.size-1},call:function(t,n){return t[n].apply(t,[].slice.call(arguments,2))},set:function(t,n){return Mark.globals[n]=t,""},log:function(t){return console.log(t),t}},"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"undefined"!=typeof module&&module.exports?module.exports=Mark:"function"==typeof define&&define.amd&&define(function(){return Mark});